<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
		<!--
		  ~ This is part of Geomajas, a GIS framework, http://www.geomajas.org/.
		  ~
		  ~ Copyright 2008-2014 Geosparc nv, http://www.geosparc.com/, Belgium.
		  ~
		  ~ The program is available in open source according to the GNU Affero
		  ~ General Public License. All contributions in this program are covered
		  ~ by the Geomajas Contributors License Agreement. For full licensing
		  ~ details, see LICENSE.txt in the project root.
		  -->
        <title>Geomajas JSON Commands API example</title>
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>

        <script type="text/javascript">
            var commandId = '';

            var token = ''; //null we allow all
            var currentJsonString = '';

            function init(){
                $(function() {
                    $( "#tabs" ).tabs();
                });

                var request = $.ajax({
                    url: "d/rest/command/list",
                    type: "GET",
                    datatype : "json",
                    contentType: "application/json; charset=utf-8"
                });

                request.done(function( json ) {
                    var options =  $( "#restsel" );

                    for (var i=0; i<json.length; i++){
                        var obj = json[i];

                        options.append($("<option />").val(obj).text(obj));
                    }

                });
                request.fail(function( jqXHR, textStatus ) {
                    //reset everything
                    $("#request" ).html(textStatus);
                    commandId ='';
                    currentJsonString = '';

                });
            }

            function postJson() {

                if ('' != currentJsonString && '' != commandId) {
                    var restURI = "d/rest/command/" + commandId + '?token=' + token;

                    var request = $.ajax({
                        url: restURI,
                        type: "POST",
                        data: currentJsonString,
                        datatype : "json",
                        contentType: "application/json; charset=utf-8"
                    });
                    request.done(function( json ) {
                        var str = JSON.stringify(json, undefined, 4);
                        $("#response" ).html(syntaxHighlight(str));

                        // activate tab
                        $( "#tabs" ).tabs( "option", "active", 1 );

                    });
                    request.fail(function( jqXHR, textStatus ) {

                        $("response").html("Response failed: "+textStatus);
                    });
                }
            }

            function getDescribe() {

                if ('' != currentJsonString && '' != commandId) {
                    var restURI = "d/rest/command/describe/" + commandId;

                    var request = $.ajax({
                        url: restURI,
                        type: "GET",
                        data: currentJsonString,
                        datatype : "json",
                        contentType: "application/json; charset=utf-8"
                    });
                    request.done(function( json ) {
                        var str = JSON.stringify(json, undefined, 4);
                        $("#response" ).html(syntaxHighlight(str));

                        // activate tab
                        $( "#tabs" ).tabs( "option", "active", 1 );

                    });
                    request.fail(function( jqXHR, textStatus ) {

                        $("response").html("Response failed: "+textStatus);
                    });
                }
            }

            function syntaxHighlight(json) {
                json = json.replace(/&/g, '&').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            function getJsonRequestObject() {
                commandId = $( "#restsel" ).val();
                if (commandId === '') return;


                $("#response" ).empty();

                // activate tab
                $( "#tabs" ).tabs( "option", "active", 0 );

                var restURI = "d/restapi/generaterequest/" + commandId;

                var request = $.ajax({
                    url: restURI,
                    type: "GET",
                    datatype : "json",
                    contentType: "application/json; charset=utf-8"
                });
                request.done(function( json ) {
                    var str = JSON.stringify(json, undefined, 4);

                    currentJsonString = str;

                    $("#request" ).html(syntaxHighlight(str));
                });
                request.fail(function( jqXHR, textStatus ) {
                    //reset everything
                    $("#request" ).html(textStatus);
                    commandId ='';
                    currentJsonString = '';

                });
            }
        </script>

        <style>
            pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
            .string { color: green; }
            .number { color: darkorange; }
            .boolean { color: blue; }
            .null { color: magenta; }
            .key { color: red; }

            .padding {
                padding: 0.5em 1em;
            }

        </style>
    </head>

    <body onload="init()">
        <a href="openLayers.html">Open layers map Geo JSON example</a>
        <br />
        <a href="leaflet.html">Leaflet map example</a>
        <h1 id="title">Geomajas JSON API</h1>
        <p>Geomajs JSON API uses only post requests. When a formatted JSON request object is posted to the server the server will answer with appropriate JSON response object. Try it yourself below.</p>

        <label>Choose a JSON request object to post</label>
        <select id="restsel" class="padding" onchange="getJsonRequestObject();">
            <option value=""></option>
        </select>

        <label>Post selected JSON to the server</label>
        <button class="padding" type="button" title="send json post request" onclick="postJson();">POST</button>
        <label>Get empty JSON request/reponse objects</label>
        <button class="padding" type="button" title="show empty request and response objects" onclick="getDescribe();">DESCRIBE</button>


        <div id="tabs" style="height: 100%; margin-top:10px;">
            <ul>
                <li><a href="#tabs-1">JSON Request</a></li>
                <li><a href="#tabs-2">JSON Response</a></li>
            </ul>
            <div id="tabs-1">
                <div id="request"></div>

            </div>
            <div id="tabs-2">
                <div id="response"></div>
             </div>
        </div>
    </body>
</html>


